# ISO vulnerability for Arc VMs running on Azure Stack HCI, version 23H2

## Description

Microsoft has identified a security vulnerability that could expose the local admin credentials used during the creation of Arc VMs on Azure Stack HCI to non-admin users on the VM and on the hosts.  

## Affected releases

Arc VMs running releases prior to Azure Stack HCI 2411 release are vulnerable.

## Mitigation

To mitigate this risk, we recommend that you rotate the passwords on the accounts used when creating Arc VMs on Azure Stack HCI. Completing this action will immediately protect your environment.  

## Ongoing protection

To ensure ongoing protection for newly provisioned VMs, update to the latest 2411 release. This release includes fixes that prevents this vulnerability for newly provisioned VMs, eliminating the need for additional password rotation.  

To mitigate this vulnerability, first identify all the Arc VMs created before the Azure Stack HCI 2411 release. Then, change the account password on each VM.

### Identify Arc VMs

1. Identify all the Arc VMs created before the Azure Stack HCI 2411 release, run the following script. Make sure to change the variables in the beginning of the script with the appropriate values.

    ```powershell
    #Variables 
    $resourceGroupName="Name of your resource group” 
    $clusterName="Name of the cluster" 
    $tenantID="GUID of the Azure Tenant" 
    $subscriptionID="GUID of the Azure Subscription" 
  
    #Login to the Azure Tenant 
    az login --tenant $tenantID 

    # Get the update date of the cluster  
    $install_date=Get-AzResource -ResourceId "/subscriptions/$subscriptionID/resourceGroups/$resourceGroup/providers/microsoft.azurestackhci/clusters/$clusterName/updates/Solution10.2408.2.7" -ExpandProperties 

    # Get the list of VMs and their creation dates 
    $vms=az stack-hci-vm list --resource-group $resourceGroup | ConvertFrom-json 

    # Format the table and flag VMs that were updated before the update date 
    $results = @() 
    foreach($vm in $vms) { 
       $condition = [datetime]$vm.properties.systemData.createdAt -le $install_date.properties.installedDate 
       $results += [PSCustomObject]@{ 
           VMName                      = $vm.Name 
           CreationDate                = [datetime]$vm.properties.systemData.createdAt 
           ClusterUpdateDate           = $install_date.properties.installedDate 
           CredentialUpdateRequired    = $condition 
       } 
    } 
    $results | Format-Table -AutoSize
        
    ```

### Change local account passwords

Arc VM creation generates two local administrator accounts: 

- Local administrator account 1

    - Name: administrator (automatically created name)
    - Password: Randomly generated password

- Local administrator account 2

    - Name: User provided name
    - Password: User provided password


> [!NOTE] We recommend changing the passwords for both local administrator accounts.

Once the Arc VMs are identified, follow these steps to change the local account passwords.
    
The steps are different for Windows and Linux VMs.

#### Windows VMs

For Windows VMs, follow these steps:

1. Sign in to the Arc VM.
2. Run the following PowerShell script. This script will help you change the passwords for both the accounts.

    Make sure to change the `$username` variable with the account name provided during Arc VM creation.

    ```powershell
    # Define the username
    $username = "AccountName"
    
    # Prompt the user to enter the new password securely
    $newPassword = Read-Host -AsSecureString "Enter the new password for $username"
    
    # Prompt the user to re-enter the new password securely for verification
    $verifyPassword = Read-Host -AsSecureString "Re-enter the new password for verification"
    
    # Convert the secure strings to plain text for comparison
    $plainPassword = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($newPassword))
    $plainVerifyPassword = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR($verifyPassword))
    
    # Check if the passwords match and change the password if they match. Fail if the passwords don’t match.
    if ($plainPassword -eq $plainVerifyPassword) {
        $account = [ADSI]"WinNT://./$username,user"
        $account.SetPassword($plainPassword)
        $account.SetInfo()
    
        Write-Host "Password for user $username has been reset successfully." -ForegroundColor Green
    } else {
        Write-Host "The passwords do not match. Please try again." -ForegroundColor Red
    }    
    ```

#### Linux VMs

For Linux VMs, follow these steps:



1. Sign in to the Arc VM.
2. Run the following script from where Bash is installed:

    If Bash is located in a different directory, make sure to change this line `#!/bin/bash` accordingly.

    ```Bash
    #!/bin/bash
    
    # Define the username
    username="AccountName"
    
    # Prompt the user to enter the new password securely
    echo -n "Enter the new password for $username: "
    read -s newPassword
    echo
    
    # Prompt the user to re-enter the new password securely for verification
    echo -n "Re-enter the new password for verification: "
    read -s verifyPassword
    echo
    
    # Check if the passwords match
    if [ "$newPassword" == "$verifyPassword" ]; then
        # Reset the password for the local account
        echo "$username:$newPassword" | sudo chpasswd
        echo -e "\e[32mPassword for user $username has been reset successfully.\e[0m"
    else
        echo -e "\e[31mThe passwords do not match. Please try again.\e[0m"
    fi
    ```
